{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Creates Pipeline Infrastructure",
    "Parameters":
    {
        "ArtifactStoreS3Location": {
            "Description": "Name of S3 bucket used as ArtifactStore",
            "Type": "String",
            "MinLength": "3",
            "MaxLength": "63",
            "AllowedPattern": "[a-zA-Z0-9\\-\\.]+",
            "ConstraintDescription": "can contain only ASCII characters."
        },
        "CodePipelineServiceRoleArn": {
          "Description": "Service Role ARN for CodePipeline",
          "Type": "String",
          "ConstraintDescription": "not a valid service role arn."
        },
        "KMSKeyArn": {
          "Description": "KMS Key ARN for S3 encryption",
          "Type": "String",
          "ConstraintDescription": "can contain only ASCII characters."
        },
        "ManagedPolicyArn": {
          "Type": "String",
          "Description": "CodeDeploy managed policy",
          "Default": "arn:aws:iam::aws:policy/service-role/AWSCodeDeployRole"
      }
    },
    "Resources":
    {
      "RoleDeployment": {
        "Type": "AWS::IAM::Role",
        "Properties": {
            "Description": "Allows CodeDeploy to call AWS services such as Auto Scaling on your behalf.",
            "AssumeRolePolicyDocument": {
                "Version": "2012-10-17",
                "Statement": [
                    {
                        "Effect": "Allow",
                        "Principal": {
                            "Service": [
                                "codedeploy.amazonaws.com"
                            ]
                        },
                        "Action": [
                            "sts:AssumeRole"
                        ]
                    }
                ]
            },
            "Path": "/",
            "ManagedPolicyArns": [
                {
                    "Ref": "ManagedPolicyArn"
                }
            ]
        }
      },
      "S3Bucket" : {
        "Type" : "AWS::S3::Bucket",
	      "DeletionPolicy": "Retain",
        "Properties" : {
           "BucketName" : { "Ref": "ArtifactStoreS3Location" }
         }  
        },
        "CodeDeploySampleApp": {
            "Type": "AWS::CodeDeploy::Application",
            "Properties": {
              "ApplicationName": "SampleApp",
              "ComputePlatform": "Server"
            }
          },
          "DeploymentGroupSampleApp": {
              "Type": "AWS::CodeDeploy::DeploymentGroup",
              "Properties":{
                  "ApplicationName": { "Ref": "CodeDeploySampleApp"},
                  "DeploymentGroupName": "SampleApp_DG",
                  "ServiceRoleArn": { "Fn::GetAtt" : [ "RoleDeployment", "Arn" ] },
                  "DeploymentConfigName": "CodeDeployDefault.OneAtATime",
                  "Ec2TagFilters" : [
                      { "Key" : "Name", "Value" : "Sample-instance", "Type" : "KEY_AND_VALUE" }, 
                      { "Key" : "Environment", "Value" : "dev", "Type" : "KEY_AND_VALUE" }]
                  }
          },
          "CodePipelineSampleApp": {
            "Type": "AWS::CodePipeline::Pipeline",
            "Properties" : {
              "Name" : "Development",
              "RoleArn" : { "Ref": "CodePipelineServiceRoleArn" },
              "Stages" : [
                {
                    "Name": "Source",
                    "Actions": [
                      {
                        "Name": "SourceAction",
                        "ActionTypeId": { 
                            "Category": "Source", 
                            "Owner": "AWS",
                            "Version": "1", 
                            "Provider": "CodeCommit"
                        },
                        "OutputArtifacts": [ { "Name": "SourceOutput" }],
                        "Configuration": {
                            "RepositoryName": "MyDemoRepo",
                            "BranchName": "master",
                            "PollForSourceChanges": "false"
                        },
                        "RunOrder": 1
                      }
                  ]
                },
                {
                    "Name": "Release",
                    "Actions":[
                        {
                            "Name": "ReleaseAction",
                            "ActionTypeId": {
                                "Category": "Deploy", 
                                "Owner": "AWS", 
                                "Version": "1", 
                                "Provider": "CodeDeploy" 
                              },
                              "InputArtifacts": [ { "Name": "SourceOutput" }],
                              "Configuration": { 
                                "ApplicationName": {"Ref" : "CodeDeploySampleApp"}, 
                                "DeploymentGroupName": {"Ref" : "DeploymentGroupSampleApp"} 
                              }, 
                              "RunOrder": 1
                        }
                    ]
                }
              ],
              "ArtifactStore": { 
                "Type": "S3",
                "Location": { "Ref" : "S3Bucket" },
                "EncryptionKey": {
                  "Id": { "Ref": "KMSKeyArn" },
                  "Type": "KMS"
                }
              }
            }
          }
    }
}